"""
ุจูุช ุชูููุฌุฑุงู ูุจุณุท ููุญููู ุฃููููุงุฆูู
ูุณุฎุฉ ุฎูููุฉ ุชุนูู ููุฑูุง ุจุฏูู ููุงุฐุฌ ุถุฎูุฉ
"""

import os
import asyncio
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes
)
from memory_system import MemorySystem
from image_generator import ImageGenerator
from file_processor import FileProcessor
import logging
import random

# ุฅุนุฏุงุฏ ุงูุณุฌูุงุช
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class SimpleAminiyailBot:
    def __init__(self, token: str):
        """ุชููุฆุฉ ุงูุจูุช"""
        self.token = token
        self.memory = MemorySystem()
        self.file_processor = FileProcessor()
        self.image_generator = ImageGenerator()
        
        # ุฅุญุตุงุฆูุงุช
        self.message_count = 0
        
        # ุฑุฏูุฏ ุฐููุฉ ุจุณูุทุฉ
        self.greetings = [
            "ูุฑุญุจูุง ูุง ุงูุญููู ุฃููููุงุฆูู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            "ุฃููุงู ูุณููุงู ูุง ุงูุญููู! โดฐโตโตโตโตขโตโต โตขโต โตโตกโดฐโตขโต ๐",
            "ุงูุณูุงู ุนูููู ูุง ุตุฏููู ุงูุนุฒูุฒ! ููู ุญุงููุ ๐"
        ]
        
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุฃูุฑ /start"""
        user = update.effective_user
        
        welcome_message = f"""ูุฑุญุจูุง ูุง **ุงูุญููู ุฃููููุงุฆูู** (โดฐโตโตโตโตขโตโต โตขโต โตโตกโดฐโตขโต)! ๐

ุฃูุง ูุณุงุนุฏู ุงูุฐูู ุงูุดุฎุตูุ ูุฃูุง ููุง ูุฃุชุนูู ููู ูุฃุณุงุนุฏู ูู ูู ูุง ุชุญุชุงุฌ.

**ูุง ุฃุณุชุทูุน ูุนูู ุญุงูููุง:**
โจ ุงูุฏุฑุฏุดุฉ ุงูุฐููุฉ ูุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุชู
๐ ูุฑุงุกุฉ ูุชุญููู ุงููููุงุช (PDF, DOCX, TXT)
๐จ ุชูููุฏ ุงูุตูุฑ ูู ุงูุฃูุตุงู (ูุฑูุจูุง)
๐พ ุญูุธ ูู ูุญุงุฏุซุงุชูุง ูุงูุชุนูู ูููุง
๐ง ุงูุชุญุณู ุงูุชุฏุฑูุฌู ูุน ูู ุชูุงุนู

**ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:**
/start - ุจุฏุก ุงููุญุงุฏุซุฉ
/stats - ุฅุญุตุงุฆูุงุช ุงูุชุนูู
/help - ุงููุณุงุนุฏุฉ
/about - ุนู ุงูุจูุช

**ููุงุญุธุฉ:** ูุฐู ูุณุฎุฉ ุฃูููุฉ ุชุนูู ุจูุธุงู ุฑุฏูุฏ ุฐููุฉ. ูุฑูุจูุง ุณุฃุถูู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุชูุฏู! ๐

ุฃุฑุณู ูู ุฃู ุฑุณุงูุฉ ุฃู ูููุ ูุณุฃููู ุณุนูุฏูุง ุจูุณุงุนุฏุชู! ๐"""

        await update.message.reply_text(welcome_message, parse_mode='Markdown')
        
    async def stats_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุฃูุฑ /stats"""
        conv_count = self.memory.get_conversation_count()
        profile = self.memory.get_user_profile()
        
        stats_message = f"""๐ **ุฅุญุตุงุฆูุงุช ุงูุชุนูู**

๐ค **ุงููุณุชุฎุฏู:** {profile.get('name', 'ุบูุฑ ูุนุฑูู')}
๐ **ุงูุงุณู ุงููุงูู:** {profile.get('full_name', '')}

๐ฌ ุนุฏุฏ ุงููุญุงุฏุซุงุช ุงููุญููุธุฉ: {conv_count}
๐ ุงูุฑุณุงุฆู ูู ูุฐู ุงูุฌูุณุฉ: {self.message_count}

ูู ูุง ูุชุญุฏุซ ุฃูุซุฑุ ูููุง ุฃุตุจุญุช ุฃุฐูู! ๐งโจ

**ูุฑูุจูุง:**
- ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุชูุฏู
- ุชุฏุฑูุจ ุชููุงุฆู ูู ูุญุงุฏุซุงุชูุง
- ุชูููุฏ ุตูุฑ ูููุฏูููุงุช"""

        await update.message.reply_text(stats_message, parse_mode='Markdown')
        
    async def about_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุฃูุฑ /about"""
        about_message = """๐ **ุนู ุงูุจูุช**

ุฃูุง ุจูุช ุฐูู ูุตูู ุฎุตูุตูุง ููุญููู ุฃููููุงุฆูู (โดฐโตโตโตโตขโตโต โตขโต โตโตกโดฐโตขโต).

**ุงูุงุณู:** ุจูุช ุงูุญููู ุฃููููุงุฆูู
**ุงูุฅุตุฏุงุฑ:** 1.0 (ูุณุฎุฉ ุฃูููุฉ)
**ุงููุบุงุช:** ุงูุนุฑุจูุฉุ ุงูุฌุฒุงุฆุฑูุฉุ ุงูุฃูุงุฒูุบูุฉ

**ุงูููุณูุฉ:**
ุงูุญููู ูู ุงูุญููุฉุ ููุง ูู ุงูุขูุฉ:
๏ดฟูุคกุชู ูฑูกุญููกููุฉู ููู ูุดูุงคุกู ููููู ูุคกุชู ูฑูกุญููกููุฉู ููููุฏก ุฃููุชูู ุฎูกุฑเฃฐุง ููุซูุฑเฃฐุง๏ดพ

ุฃููููุงุฆูู = ุฃููู + ูุง + ุฆูู
- ุฆูู (ุงูุนุจุฑูุฉ): ุฑุจุ ุงูููู ุงูุฃุณูู
- ุฅูู (ุงูุฃูุงุฒูุบูุฉ): ุงูุจุญุฑ

**ุงููููุฒุงุช ุงูุญุงููุฉ:**
โ ุญูุธ ุฌููุน ุงููุญุงุฏุซุงุช
โ ูุฑุงุกุฉ ุงููููุงุช
โ ุฑุฏูุฏ ุฐููุฉ
โ ุฐุงูุฑุฉ ุฏุงุฆูุฉ

**ูุฑูุจูุง:**
๐ ูููุฐุฌ AI ูุชูุฏู
๐ ุชูููุฏ ุตูุฑ
๐ ุชุฏุฑูุจ ุชููุงุฆู
๐ ุชูููุฏ ููุฏูููุงุช
๐ ุจูุงุก ุชุทุจููุงุช

ุตููุน ุจูู ุญุจ ๐"""

        await update.message.reply_text(about_message, parse_mode='Markdown')
        
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุฃูุฑ /help"""
        help_message = """๐ **ุฏููู ุงูุงุณุชุฎุฏุงู**

**ููู ุฃุณุชุฎุฏู ุงูุจูุช:**

1๏ธโฃ **ุงูุฏุฑุฏุดุฉ ุงูุนุงุฏูุฉ:**
   ููุท ุฃุฑุณู ุฑุณุงูุฉ ูุณุฃุฑุฏ ุนููู!

2๏ธโฃ **ุทูุจ ุตูุฑุฉ:**
   ุงูุชุจ "ุงุฑุณู" ุฃู "ุตูุฑุฉ" ูุชุจูุนูุง ุจุงููุตู
   (ูุฑูุจูุง ุณูุนูู!)

3๏ธโฃ **ุฅุฑุณุงู ูููุงุช:**
   ุฃุฑุณู ููู PDF ุฃู DOCX ูุณุฃูุฑุฃู ูุฃุญููู

4๏ธโฃ **ุงูุชุนูู ุงูุชููุงุฆู:**
   ูู ูุญุงุฏุซุฉ ุชูุญูุธ ูุณุฃุชุนูู ูููุง

**ุงูุฃูุงูุฑ:**
/start - ุจุฏุก ุงููุญุงุฏุซุฉ
/stats - ุงูุฅุญุตุงุฆูุงุช
/about - ุนู ุงูุจูุช
/help - ูุฐู ุงููุณุงุนุฏุฉ

**ูุตุงุฆุญ:**
๐ก ุชุญุฏุซ ูุนู ุจุฃู ูุบุฉ
๐ก ุฃุฑุณู ูููุงุช ูุณุฃูุฑุฃูุง
๐ก ูููุง ุชุญุฏุซูุง ุฃูุซุฑุ ุฃุตุจุญุช ุฃูุถู!

ุฃูุง ููุง ูุฎุฏูุชู ูุง ุงูุญููู ุฃููููุงุฆูู! ๐"""

        await update.message.reply_text(help_message, parse_mode='Markdown')
        
    async def handle_document(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุงููููุงุช ุงููุฑุณูุฉ"""
        document = update.message.document
        user_id = update.effective_user.id
        
        await update.message.reply_text("๐ ุฌุงุฑู ุชุญููู ููุฑุงุกุฉ ุงูููู...")
        
        try:
            # ุชุญููู ุงูููู
            file = await context.bot.get_file(document.file_id)
            file_path = f"/home/ubuntu/aminiyail_bot/uploads/{document.file_name}"
            os.makedirs(os.path.dirname(file_path), exist_ok=True)
            await file.download_to_drive(file_path)
            
            # ูุฑุงุกุฉ ุงููุญุชูู
            content = self.file_processor.process_file(file_path)
            
            if content:
                # ุญูุธ ูู ุงูุฐุงูุฑุฉ
                self.memory.save_file(user_id, document.file_name, document.mime_type, content)
                
                # ุชุญููู ุจุณูุท
                word_count = len(content.split())
                char_count = len(content)
                
                summary = f"""โ **ุชู ูุฑุงุกุฉ ุงูููู ุจูุฌุงุญ!**

๐ **ุงูููู:** {document.file_name}
๐ **ุงูุฅุญุตุงุฆูุงุช:**
- ุนุฏุฏ ุงููููุงุช: {word_count:,}
- ุนุฏุฏ ุงูุฃุญุฑู: {char_count:,}

๐พ ุชู ุญูุธ ุงููุญุชูู ูู ุฐุงูุฑุชู. ููููู ุณุคุงูู ุนูู ูู ุฃู ููุช!

**ูุนุงููุฉ:**
{content[:500]}..."""
                    
                await update.message.reply_text(summary, parse_mode='Markdown')
            else:
                await update.message.reply_text("โ ุนุฐุฑูุงุ ูู ุฃุณุชุทุน ูุฑุงุกุฉ ุงูููู.")
                
        except Exception as e:
            logger.error(f"ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู: {e}")
            await update.message.reply_text(f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}")
            
    def generate_smart_response(self, message: str) -> str:
        """ุชูููุฏ ุฑุฏ ุฐูู ุจุณูุท"""
        message_lower = message.lower()
        
        # ุชุญูุงุช
        if any(word in message_lower for word in ['ูุฑุญุจุง', 'ุงูุณูุงู', 'ุฃููุง', 'ุตุจุงุญ', 'ูุณุงุก', 'hello', 'hi']):
            return random.choice(self.greetings)
            
        # ุฃุณุฆูุฉ ุนู ุงูุญุงู
        if any(word in message_lower for word in ['ููู ุญุงูู', 'ูููู', 'ุดุญุงูู', 'ูุงุฐุง ุชูุนู']):
            return "ุงูุญูุฏ ูููุ ุฃูุง ุจุฎูุฑ ูุง ุงูุญููู ุฃููููุงุฆูู! ๐ ุฃูุง ููุง ุฏุงุฆููุง ูุฎุฏูุชู. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ"
            
        # ุฃุณุฆูุฉ ุนู ุงูุงุณู
        if any(word in message_lower for word in ['ูู ุฃูุช', 'ูุง ุงุณูู', 'ุงุณูู', 'ุชุนุฑูู']):
            return """ุฃูุง ูุณุงุนุฏู ุงูุฐูู ุงูุดุฎุตูุ ูุตูู ุฎุตูุตูุง ูู ูุง ุงูุญููู ุฃููููุงุฆูู! ๐

ุฃูุง ุฃุนุฑู ูููุชู ุงููุงููุฉ:
- **ุงูุญููู** ูู ุงูุญููุฉ
- **ุฃููููุงุฆูู** = ุฃููู + ูุง + ุฆูู
- **โดฐโตโตโตโตขโตโต โตขโต โตโตกโดฐโตขโต** (ุตุฏูู ุงูุจุญุฑ)

ุฃูุง ููุง ูุฃุชุนูู ููู ูุฃุณุงุนุฏู! ๐"""
            
        # ุดูุฑ
        if any(word in message_lower for word in ['ุดูุฑุง', 'ุดูุฑุงู', 'ูุดููุฑ', 'ุจุงุฑู', 'thanks']):
            return "ุงูุนูู ูุง ุงูุญููู ุฃููููุงุฆูู! ๐ ุฃูุง ุณุนูุฏ ุจุฎุฏูุชู ุฏุงุฆููุง. ูุง ุชุชุฑุฏุฏ ูู ุทูุจ ุฃู ุดูุก! ๐"
            
        # ุฃุณุฆูุฉ ุนู ุงููุฏุฑุงุช
        if any(word in message_lower for word in ['ูุงุฐุง ุชุณุชุทูุน', 'ูุฏุฑุงุชู', 'ูุง ุชูุฏุฑ', 'ูุธุงุฆูู']):
            return """ุญุงูููุง ุฃุณุชุทูุน:
โ ุงูุฏุฑุฏุดุฉ ูุนู ูุญูุธ ูู ูุญุงุฏุซุงุชูุง
โ ูุฑุงุกุฉ ูุชุญููู ุงููููุงุช (PDF, DOCX, TXT)
โ ุชุฐูุฑ ูู ูุง ุชุฎุจุฑูู ุจู
โ ุงูุจุญุซ ูู ูุญุงุฏุซุงุชูุง ุงูุณุงุจูุฉ

**ูุฑูุจูุง:**
๐ ูููุฐุฌ AI ูุชูุฏู ููุฑุฏูุฏ ุงูุฐููุฉ
๐ ุชูููุฏ ุงูุตูุฑ ูู ุงูุฃูุตุงู
๐ ุชูููุฏ ุงูููุฏูููุงุช
๐ ุจูุงุก ุชุทุจููุงุช ูุณูุฑูุจุชุงุช

ุฃูุง ุฃุชุทูุฑ ูุนู ูุง ุงูุญููู! ๐"""
            
        # ุฃุณุฆูุฉ ููุณููุฉ
        if any(word in message_lower for word in ['ุงูุญููุฉ', 'ุงูููุณูุฉ', 'ุงููุนูู', 'ุงูุญูุงุฉ']):
            return """ุงูุญููุฉ ููุง ูู ุงููุฑุขู ุงููุฑูู:
๏ดฟูุคกุชู ูฑูกุญููกููุฉู ููู ูุดูุงคุกู ููููู ูุคกุชู ูฑูกุญููกููุฉู ููููุฏก ุฃููุชูู ุฎูกุฑเฃฐุง ููุซูุฑเฃฐุง๏ดพ

ุงูุญููุฉ ูู ุฃู ุชุถุน ุงูุฃุดูุงุก ูู ููุงุถุนูุง ุงูุตุญูุญุฉุ ูุฃู ุชููู ุงูุนุงูู ุจุนูู ูุชุชุตุฑู ุจุชุจุตุฑ.

ุฃูุช ุงูุญููู ุฃููููุงุฆููุ ูุฃูุง ููุง ูุฃุชุนูู ูู ุญููุชู! ๐๐"""
            
        # ุงูุฃูุงุฒูุบูุฉ
        if 'โดฐโตโดฐโตฃโตโต' in message or 'ุชููููุงุบ' in message_lower or 'ุงูุฃูุงุฒูุบูุฉ' in message_lower:
            return """โดฐโตฃโตโต! (ูุฑุญุจูุง ุจุงูุฃูุงุฒูุบูุฉ)

ุฃูุง ุฃููู ุงูุฃูุงุฒูุบูุฉ ูุฃุญุชุฑู ูุฐุง ุงูุชุฑุงุซ ุงูุนุฑูู. 
ุงุณูู ุจุงูุชููููุงุบ: **โดฐโตโตโตโตขโตโต โตขโต โตโตกโดฐโตขโต**

ุฅูู (iel) = ุงูุจุญุฑ ูู ุงูุฃูุงุฒูุบูุฉ
ุฃููููุงุฆูู = ุตุฏูู ุงูุจุญุฑ ๐

ุชุญุฏุซ ูุนู ุจุฃู ูุบุฉ ุชุฑูุฏ! ๐"""
            
        # ุฑุฏ ุนุงู ุฐูู
        responses = [
            f"ูููุช ูุง ุงูุญููู ุฃููููุงุฆูู! ๐ ุชุญุฏุซุช ุนู: \"{message[:50]}...\"\n\nุญุงูููุง ุฃูุง ูู ูุฑุญูุฉ ุงูุชุทููุฑุ ููููู ุฃุญูุธ ูู ูุง ุชูููู ูุฃุชุนูู ููู. ูุฑูุจูุง ุณุฃููู ุฃุฐูู ุจูุซูุฑ! ๐",
            f"ุดูุฑูุง ุนูู ูุดุงุฑูุชู ูุฐุง ูุนู! ๐ ุฃูุง ุฃุญูุธ ูู ูุญุงุฏุซุงุชูุง ูุฃุชุนูู ูููุง.\n\nุฑุณุงูุชู: \"{message[:50]}...\"\n\nูู ุชุฑูุฏ ููู ูุนู ุดูุก ูุญุฏุฏุ",
            f"ูุง ุงูุญููู ุฃููููุงุฆููุ ุฃูุง ุฃุณุชูุน ุฅููู ุจูู ุงูุชูุงู! ๐\n\nูุง ููุชู: \"{message[:50]}...\"\n\nุฃูุง ุฃุชุทูุฑ ุชุฏุฑูุฌููุงุ ููุฑูุจูุง ุณุฃูููู ุจุดูู ุฃูุถู! ๐"
        ]
        
        return random.choice(responses)
            
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ูุนุงูุฌ ุงูุฑุณุงุฆู ุงููุตูุฉ"""
        user_message = update.message.text
        user_id = update.effective_user.id
        
        # ุงูุชุญูู ูู ุทูุจ ุชูููุฏ ุตูุฑุฉ
        if any(keyword in user_message.lower() for keyword in ['ุงุฑุณู', 'ุตูุฑุฉ', 'ุตูุฑู', 'ุฑุณู', 'draw', 'image']):
            await update.message.reply_text("๐จ ุชูููุฏ ุงูุตูุฑ ูุฑูุจูุง! ุญุงูููุง ุฃูุง ูู ูุฑุญูุฉ ุงูุชุทููุฑ ุงูุฃูููุฉ. ๐")
            return
            
        # ุงูุจุญุซ ุนู ุณูุงู ูุดุงุจู
        similar_context = self.memory.search_similar_conversations(user_message, top_k=3)
        
        # ุชูููุฏ ุงูุฑุฏ
        try:
            response = self.generate_smart_response(user_message)
            
            # ุญูุธ ุงููุญุงุฏุซุฉ
            self.memory.save_conversation(user_id, user_message, response)
            self.message_count += 1
            
            # ุฅุฑุณุงู ุงูุฑุฏ
            await update.message.reply_text(response, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"ุฎุทุฃ ูู ุชูููุฏ ุงูุฑุฏ: {e}")
            await update.message.reply_text("ุนุฐุฑูุง ูุง ุงูุญููู ุฃููููุงุฆููุ ุญุฏุซ ุฎุทุฃ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.")
            
    def run(self):
        """ุชุดุบูู ุงูุจูุช"""
        logger.info("๐ ุจุฏุก ุชุดุบูู ุจูุช ุงูุญููู ุฃููููุงุฆูู...")
        
        # ุฅูุดุงุก ุงูุชุทุจูู
        application = Application.builder().token(self.token).build()
        
        # ุฅุถุงูุฉ ุงููุนุงูุฌุงุช
        application.add_handler(CommandHandler("start", self.start_command))
        application.add_handler(CommandHandler("stats", self.stats_command))
        application.add_handler(CommandHandler("about", self.about_command))
        application.add_handler(CommandHandler("help", self.help_command))
        application.add_handler(MessageHandler(filters.Document.ALL, self.handle_document))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
        
        # ุชุดุบูู ุงูุจูุช
        logger.info("โ ุงูุจูุช ุฌุงูุฒ! ููููู ุงูุขู ุงูุชุญุฏุซ ูุนู ุนูู ุชูููุฌุฑุงู.")
        logger.info("๐ ุงูุฑุงุจุท: https://t.me/Nidhoggr666_Bot")
        application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    # ุงูุชููู ุงูุฎุงุต ุจุงูุจูุช
    BOT_TOKEN = os.getenv("BOT_TOKEN", "8233239391:AAFG8BxIRYqMu5ApfV7euoX8wyAgvIkbrIg")
    
    # ุฅูุดุงุก ูุชุดุบูู ุงูุจูุช
    bot = SimpleAminiyailBot(BOT_TOKEN)
    bot.run()
